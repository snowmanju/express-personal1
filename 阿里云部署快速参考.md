# 阿里云部署快速参考卡片

## 🚀 快速开始（3步部署）

### 方法1: 使用一键部署脚本 ⭐⭐⭐⭐⭐

```bash
# 1. 连接到服务器
ssh root@your_server_ip

# 2. 下载并运行部署脚本
wget https://your-domain.com/deploy_aliyun.sh
chmod +x deploy_aliyun.sh
./deploy_aliyun.sh

# 3. 按提示操作，完成！
```

### 方法2: 手动部署（Docker）

```bash
# 1. 安装Docker和Docker Compose
curl -fsSL https://get.docker.com | sh
curl -L "https://github.com/docker/compose/releases/download/v2.23.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose

# 2. 上传项目到 /opt/sf-express

# 3. 配置并启动
cd /opt/sf-express
cp .env.example .env.production
nano .env.production  # 修改配置
docker-compose --env-file .env.production up -d --build
```

---

## 📋 服务器要求

| 项目 | 最低配置 | 推荐配置 |
|------|----------|----------|
| CPU | 2核 | 4核 |
| 内存 | 4GB | 8GB |
| 存储 | 40GB | 100GB |
| 带宽 | 3Mbps | 5Mbps+ |
| 系统 | Ubuntu 22.04 | Ubuntu 22.04 |

---

## 🔧 必须配置的端口（安全组）

| 端口 | 协议 | 说明 | 授权对象 |
|------|------|------|----------|
| 22 | TCP | SSH | 你的IP |
| 80 | TCP | HTTP | 0.0.0.0/0 |
| 443 | TCP | HTTPS | 0.0.0.0/0 |

**注意**: 不要开放3306端口（MySQL）！

---

## 📝 环境变量配置清单

```env
# 必须修改的配置
MYSQL_ROOT_PASSWORD=强密码
MYSQL_PASSWORD=强密码
SECRET_KEY=至少32位随机字符串
REDIS_PASSWORD=强密码

# 快递100 API（使用你的真实配置）
KUAIDI100_KEY=你的KEY
KUAIDI100_CUSTOMER=你的CUSTOMER
KUAIDI100_SECRET=你的SECRET
KUAIDI100_USERID=你的USERID
```

**生成强密钥**:
```bash
openssl rand -base64 32
```

---

## 🎯 部署后检查清单

- [ ] 服务启动成功: `docker-compose ps`
- [ ] 能访问前台: `http://服务器IP`
- [ ] 能访问后台: `http://服务器IP/admin/login.html`
- [ ] API正常: `http://服务器IP:8000/docs`
- [ ] 能登录管理后台（admin/admin123）
- [ ] 能上传理货单
- [ ] 能查询快递

---

## 🔐 安全配置（必做）

### 1. 修改管理员密码
登录后台后立即修改默认密码

### 2. 配置SSL证书（Let's Encrypt）
```bash
# 安装certbot
apt install -y certbot python3-certbot-nginx

# 获取证书
certbot --nginx -d yourdomain.com

# 自动续期
certbot renew --dry-run
```

### 3. 配置防火墙
```bash
ufw allow 22/tcp
ufw allow 80/tcp
ufw allow 443/tcp
ufw enable
```

### 4. 设置定期备份
```bash
# 创建备份脚本
nano /opt/backup.sh

# 添加定时任务（每天3点备份）
crontab -e
0 3 * * * /opt/backup.sh
```

---

## 📊 常用命令

### Docker部署

```bash
# 进入项目目录
cd /opt/sf-express

# 查看服务状态
docker-compose --env-file .env.production ps

# 查看日志
docker-compose --env-file .env.production logs -f

# 重启服务
docker-compose --env-file .env.production restart

# 停止服务
docker-compose --env-file .env.production down

# 重新构建
docker-compose --env-file .env.production up -d --build

# 进入容器
docker-compose --env-file .env.production exec app bash

# 备份数据库
docker-compose --env-file .env.production exec db mysqldump -u root -p express_tracking > backup.sql
```

### 系统管理

```bash
# 查看资源使用
htop
docker stats

# 查看磁盘空间
df -h

# 查看端口占用
netstat -tlnp

# 查看防火墙状态
ufw status

# 查看系统日志
journalctl -f
```

---

## 🆘 常见问题快速解决

### 问题1: 服务无法启动
```bash
# 检查端口占用
netstat -tlnp | grep :8000

# 查看日志
docker-compose --env-file .env.production logs

# 重启Docker
systemctl restart docker
```

### 问题2: 无法访问网站
```bash
# 检查防火墙
ufw status

# 检查安全组（阿里云控制台）

# 检查Nginx
docker-compose --env-file .env.production exec nginx nginx -t
```

### 问题3: 数据库连接失败
```bash
# 检查数据库状态
docker-compose --env-file .env.production exec db mysqladmin ping

# 查看数据库日志
docker-compose --env-file .env.production logs db

# 重启数据库
docker-compose --env-file .env.production restart db
```

### 问题4: 内存不足
```bash
# 添加swap空间
fallocate -l 2G /swapfile
chmod 600 /swapfile
mkswap /swapfile
swapon /swapfile
echo '/swapfile none swap sw 0 0' >> /etc/fstab
```

---

## 📞 访问地址

部署完成后的访问地址：

- **前台查询**: http://服务器IP 或 http://域名
- **管理后台**: http://服务器IP/admin/login.html
- **API文档**: http://服务器IP:8000/docs
- **健康检查**: http://服务器IP:8000/health

**默认账号**:
- 用户名: `admin`
- 密码: `admin123`

---

## 📁 重要文件位置

```
/opt/sf-express/              # 项目根目录
├── .env.production           # 环境配置
├── passwords.txt             # 密码文件（自动生成）
├── docker-compose.yml        # Docker配置
├── uploads/                  # 上传文件
├── logs/                     # 日志文件
└── docker/nginx/ssl/         # SSL证书
```

---

## 🔄 更新部署

```bash
# 1. 备份数据
cd /opt/sf-express
docker-compose --env-file .env.production exec db mysqldump -u root -p express_tracking > backup.sql

# 2. 拉取最新代码
git pull origin main

# 3. 重新构建并启动
docker-compose --env-file .env.production up -d --build

# 4. 运行数据库迁移
docker-compose --env-file .env.production exec app alembic upgrade head
```

---

## 📚 详细文档

- **完整部署指南**: [阿里云服务器部署指南.md](阿里云服务器部署指南.md)
- **项目说明**: [sf-express/项目说明.md](sf-express/项目说明.md)
- **问题解决**: [问题汇总与解决方案.md](问题汇总与解决方案.md)

---

## ⏱️ 预计部署时间

- **使用一键脚本**: 15-20分钟
- **手动部署**: 30-40分钟
- **包含SSL配置**: +10分钟
- **包含域名配置**: +5分钟

---

## ✅ 部署成功标志

1. ✅ 所有Docker容器运行正常
2. ✅ 能访问前台页面
3. ✅ 能登录管理后台
4. ✅ 能上传理货单
5. ✅ 能查询快递信息
6. ✅ API文档可访问

---

## 🎉 完成后的下一步

1. **立即修改管理员密码**
2. 配置域名解析
3. 安装SSL证书
4. 设置定期备份
5. 配置监控告警
6. 测试所有功能
7. 培训使用人员

---

**需要帮助？**

查看完整文档：[阿里云服务器部署指南.md](阿里云服务器部署指南.md)

**祝部署顺利！** 🚀
