# 快递追踪系统平台可用性测试指南

## 测试前准备

### 1. 环境检查

```bash
# 检查Python版本（需要3.8+）
python --version

# 检查虚拟环境
cd E:\kiro
.\venv\Scripts\activate

# 检查依赖包
pip list | findstr "fastapi pandas sqlalchemy"
```

### 2. 数据库准备

```bash
# 确保MySQL服务运行
# 方法1: 通过服务管理器启动MySQL
# 方法2: 命令行启动
net start MySQL

# 测试数据库连接
mysql -u root -p
# 输入密码后，检查数据库是否存在
SHOW DATABASES;
USE express_tracking;
SHOW TABLES;
```

### 3. 创建测试管理员账户

```bash
# 运行创建管理员脚本
python create_admin_user.py

# 输入信息：
# 用户名: admin
# 密码: admin123
```

---

## 测试步骤

## 第一部分：后端API测试

### 测试1: 启动后端服务

```bash
# 在项目根目录下
cd E:\kiro

# 激活虚拟环境
.\venv\Scripts\activate

# 启动后端服务
python run.py
```

**预期结果**:
```
INFO:     Started server process
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8000
```

**验证**: 浏览器访问 http://localhost:8000 应该看到欢迎页面

---

### 测试2: 管理员登录API

打开新的命令行窗口（保持服务运行）：

```bash
# 测试登录API
curl -X POST http://localhost:8000/api/v1/auth/login ^
  -H "Content-Type: application/json" ^
  -d "{\"username\":\"admin\",\"password\":\"admin123\"}"
```

**预期结果**:
```json
{
  "access_token": "eyJ0eXAiOiJKV1QiLCJhbGc...",
  "token_type": "bearer",
  "user": {
    "id": 1,
    "username": "admin"
  }
}
```

**保存token**: 复制 `access_token` 的值，后续测试需要使用

---

### 测试3: 模板下载API

```bash
# 替换 YOUR_TOKEN 为上一步获取的token
curl -X GET http://localhost:8000/api/v1/admin/manifest/template/download ^
  -H "Authorization: Bearer YOUR_TOKEN" ^
  -o test_template.csv
```

**预期结果**:
- 下载成功，生成 `test_template.csv` 文件
- 文件包含正确的列标题和示例数据

**验证**: 用Excel或记事本打开 `test_template.csv`，检查内容

---

### 测试4: CSV文件上传API（预览模式）

```bash
# 使用下载的模板文件测试上传（预览模式）
curl -X POST http://localhost:8000/api/v1/admin/manifest/upload ^
  -H "Authorization: Bearer YOUR_TOKEN" ^
  -F "file=@test_template.csv" ^
  -F "preview_only=true"
```

**预期结果**:
```json
{
  "success": true,
  "message": "文件预览成功",
  "statistics": {
    "total_rows": 3,
    "valid_rows": 3,
    "invalid_rows": 0,
    "inserted": 0,
    "updated": 0,
    "skipped": 0
  },
  "preview_data": [...]
}
```

---

### 测试5: CSV文件上传API（保存模式）

```bash
# 上传并保存到数据库
curl -X POST http://localhost:8000/api/v1/admin/manifest/upload ^
  -H "Authorization: Bearer YOUR_TOKEN" ^
  -F "file=@test_template.csv" ^
  -F "preview_only=false"
```

**预期结果**:
```json
{
  "success": true,
  "message": "文件处理成功",
  "statistics": {
    "total_rows": 3,
    "valid_rows": 3,
    "invalid_rows": 0,
    "inserted": 3,
    "updated": 0,
    "skipped": 0
  }
}
```

**验证数据库**:
```sql
-- 在MySQL中查询
USE express_tracking;
SELECT * FROM cargo_manifest ORDER BY created_at DESC LIMIT 5;
```

---

## 第二部分：前端界面测试

### 测试6: 访问管理后台登录页

1. 打开浏览器
2. 访问: http://localhost:8000/admin/login.html
3. 输入用户名: `admin`
4. 输入密码: `admin123`
5. 点击"登录"按钮

**预期结果**:
- 登录成功，跳转到管理后台首页
- 显示统计数据和导航菜单

---

### 测试7: 模板下载功能

1. 在管理后台，点击"文件上传"标签
2. 点击"下载模板"按钮

**预期结果**:
- 浏览器下载 `manifest_upload_template.csv` 文件
- 文件包含正确的列标题和示例数据

---

### 测试8: CSV文件预览功能

1. 在"文件上传"页面
2. 点击"选择文件"，选择刚下载的模板文件
3. **勾选**"仅预览数据，不保存到数据库"
4. 点击"上传文件"按钮

**预期结果**:
- 显示上传统计信息
- 显示数据预览表格
- 数据库中没有新增记录

**验证**:
```sql
-- 记录上传前的记录数
SELECT COUNT(*) FROM cargo_manifest;
-- 预览后记录数应该相同
```

---

### 测试9: CSV文件保存功能

1. 在"文件上传"页面
2. 点击"选择文件"，选择模板文件
3. **不勾选**"仅预览数据，不保存到数据库"
4. 点击"上传文件"按钮

**预期结果**:
- 显示"文件上传成功"提示
- 显示上传统计信息（inserted数量 > 0）
- 表单自动清空

**验证**:
```sql
-- 数据库中应该有新增记录
SELECT COUNT(*) FROM cargo_manifest;
SELECT * FROM cargo_manifest ORDER BY created_at DESC LIMIT 5;
```

---

### 测试10: 理货单查询功能

1. 点击"理货单管理"标签
2. 在搜索框输入刚上传的快递单号
3. 点击"搜索"按钮

**预期结果**:
- 显示匹配的理货单记录
- 记录信息完整准确

---

### 测试11: 理货单编辑功能

1. 在理货单列表中，点击某条记录的"编辑"按钮
2. 修改某些字段（如重量、尺寸）
3. 点击"保存"按钮

**预期结果**:
- 显示"更新成功"提示
- 列表中的数据已更新
- 数据库中的记录已更新

---

### 测试12: 理货单删除功能

1. 在理货单列表中，选中一条或多条记录
2. 点击"批量删除"按钮
3. 确认删除

**预期结果**:
- 显示"删除成功"提示
- 记录从列表中消失
- 数据库中的记录已删除

---

## 第三部分：错误处理测试

### 测试13: 无效文件格式

1. 创建一个 `.txt` 文件
2. 尝试上传该文件

**预期结果**:
- 显示错误提示："不支持的文件格式"
- 文件未被处理

---

### 测试14: 超大文件

1. 创建一个超过10MB的CSV文件
2. 尝试上传

**预期结果**:
- 显示错误提示："文件大小超过限制"
- 文件未被处理

---

### 测试15: 无效数据

1. 编辑模板文件，删除必填字段的值
2. 上传该文件

**预期结果**:
- 显示验证错误
- 列出具体的错误行和错误信息
- 有效行仍然可以处理（如果是保存模式）

---

### 测试16: 重复快递单号

1. 上传包含已存在快递单号的文件
2. 查看处理结果

**预期结果**:
- 显示更新统计（updated数量 > 0）
- 现有记录被更新而不是插入新记录

---

### 测试17: 未授权访问

1. 退出登录
2. 尝试直接访问 http://localhost:8000/admin/dashboard.html

**预期结果**:
- 自动跳转到登录页面
- 或显示"未授权"错误

---

## 第四部分：性能测试

### 测试18: 大文件处理

1. 创建包含1000行数据的CSV文件
2. 上传该文件（保存模式）
3. 记录处理时间

**预期结果**:
- 处理时间 < 30秒
- 所有有效记录成功保存
- 界面保持响应

**创建测试文件脚本**:
```python
# create_large_csv.py
import csv
from datetime import datetime, timedelta

with open('large_test.csv', 'w', newline='', encoding='utf-8-sig') as f:
    writer = csv.writer(f)
    writer.writerow(['理货日期', '快递单号', '集包单号', '长度', '宽度', '高度', '重量', '货物代码', '客户代码', '运输代码'])
    
    base_date = datetime.now()
    for i in range(1000):
        date = (base_date - timedelta(days=i % 30)).strftime('%Y-%m-%d')
        tracking = f'TEST{i:06d}'
        package = f'PKG{i:04d}'
        writer.writerow([date, tracking, package, 30, 20, 10, 5.5, 'G001', 'C001', 'T001'])

print("创建了包含1000行的测试文件: large_test.csv")
```

---

### 测试19: 并发上传

1. 打开两个浏览器标签页
2. 同时在两个页面上传不同的文件
3. 观察处理结果

**预期结果**:
- 两个上传都成功完成
- 没有数据冲突或丢失
- 统计信息准确

---

## 第五部分：自动化测试

### 测试20: 运行单元测试

```bash
# 运行所有单元测试
python -m pytest test_file_validator_unit.py test_template_download.py -v

# 预期: 所有测试通过
```

---

### 测试21: 运行属性测试

```bash
# 运行文件验证属性测试
python -m pytest test_file_validation_properties.py -v

# 预期: 所有属性测试通过
```

---

## 测试检查清单

### 功能测试
- [ ] 管理员登录成功
- [ ] 模板下载成功
- [ ] CSV文件预览成功
- [ ] CSV文件保存成功
- [ ] Excel文件上传成功
- [ ] 理货单查询成功
- [ ] 理货单编辑成功
- [ ] 理货单删除成功
- [ ] 统计数据显示正确

### 错误处理
- [ ] 无效文件格式被拒绝
- [ ] 超大文件被拒绝
- [ ] 无效数据显示错误信息
- [ ] 重复快递单号正确处理
- [ ] 未授权访问被阻止

### 性能测试
- [ ] 大文件处理时间合理
- [ ] 并发上传正常工作
- [ ] 界面响应流畅

### 数据完整性
- [ ] 预览模式不修改数据库
- [ ] 保存模式正确保存数据
- [ ] 更新操作正确更新记录
- [ ] 删除操作正确删除记录
- [ ] 中文字符正确显示

---

## 常见问题排查

### 问题1: 无法启动服务
**症状**: `python run.py` 报错

**解决方案**:
```bash
# 检查端口占用
netstat -ano | findstr :8000

# 如果端口被占用，修改配置或结束占用进程
# 或者修改 run.py 中的端口号
```

### 问题2: 数据库连接失败
**症状**: 启动时报数据库连接错误

**解决方案**:
```bash
# 1. 检查MySQL服务是否运行
net start MySQL

# 2. 检查 .env 文件中的数据库配置
# DATABASE_URL=mysql+pymysql://root:password@localhost:3306/express_tracking

# 3. 测试数据库连接
mysql -u root -p
```

### 问题3: 上传文件失败
**症状**: 上传时显示错误

**解决方案**:
1. 检查文件格式（必须是 .csv, .xlsx, .xls）
2. 检查文件大小（不超过10MB）
3. 检查文件编码（建议UTF-8）
4. 检查列标题是否与模板一致

### 问题4: 中文显示乱码
**症状**: 上传的中文数据显示为乱码

**解决方案**:
1. 确保CSV文件使用UTF-8编码保存
2. 在Excel中另存为CSV时选择"CSV UTF-8"格式
3. 检查数据库字符集设置

---

## 测试报告模板

```
测试日期: ____________________
测试人员: ____________________
测试环境: ____________________

测试结果汇总:
- 通过测试: _____ / _____
- 失败测试: _____
- 阻塞问题: _____

详细测试结果:
[列出每个测试的结果]

发现的问题:
1. [问题描述]
   - 严重程度: [高/中/低]
   - 重现步骤: [...]
   - 预期结果: [...]
   - 实际结果: [...]

建议:
[测试建议和改进意见]

签名: ____________________
```

---

## 快速测试脚本

创建 `quick_test.bat` 文件：

```batch
@echo off
echo ========================================
echo 快递追踪系统快速测试
echo ========================================
echo.

echo [1/5] 检查Python环境...
python --version
if errorlevel 1 (
    echo 错误: Python未安装或未添加到PATH
    pause
    exit /b 1
)

echo [2/5] 激活虚拟环境...
call venv\Scripts\activate

echo [3/5] 检查依赖包...
pip show fastapi >nul 2>&1
if errorlevel 1 (
    echo 错误: FastAPI未安装
    echo 运行: pip install -r requirements.txt
    pause
    exit /b 1
)

echo [4/5] 运行单元测试...
python -m pytest test_file_validator_unit.py test_template_download.py -v --tb=short

echo [5/5] 测试完成！
echo.
echo 下一步: 启动服务器测试前端
echo 命令: python run.py
echo.
pause
```

运行: 双击 `quick_test.bat` 或在命令行执行 `quick_test.bat`

---

## 总结

完成以上所有测试后，你的平台应该：
1. ✅ 后端API正常工作
2. ✅ 前端界面功能完整
3. ✅ 文件上传处理正确
4. ✅ 数据验证有效
5. ✅ 错误处理完善
6. ✅ 性能满足要求
7. ✅ 数据完整性保证

如果所有测试通过，平台即可投入使用！
