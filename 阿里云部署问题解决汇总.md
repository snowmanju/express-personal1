# é˜¿é‡Œäº‘éƒ¨ç½²é—®é¢˜è§£å†³æ±‡æ€»

## ğŸ“‹ é—®é¢˜åˆ—è¡¨

### é—®é¢˜1: GitHubè®¿é—®è¶…æ—¶ âœ…
**é—®é¢˜**: åœ¨é˜¿é‡Œäº‘æœåŠ¡å™¨ä¸Šæ‰§è¡Œ `curl` è®¿é—® GitHub æ—¶è¶…æ—¶
```
curl: (28) Failed to connect to github.com port 443 after 136218 ms
```

**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨å›½å†…é•œåƒæº
- ä½¿ç”¨ DaoCloud é•œåƒå®‰è£… Docker Compose
- ä½¿ç”¨ apt/yum åŒ…ç®¡ç†å™¨å®‰è£…
- æˆ–ç›´æ¥ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨

**ç›¸å…³æ–‡æ¡£**:
- `GitHubè®¿é—®é—®é¢˜è§£å†³æ–¹æ¡ˆ.md`
- `å¿«é€Ÿè§£å†³GitHubè®¿é—®é—®é¢˜.md`

---

### é—®é¢˜2: .kiro æ–‡ä»¶å¤¹æ— æ³•ä¸Šä¼ åˆ° GitHub âœ…
**é—®é¢˜**: GitHub Desktop é€‰æ‹© .kiro æ–‡ä»¶å¤¹æ—¶æ˜¾ç¤ºæ²¡æœ‰æ–‡ä»¶

**è§£å†³æ–¹æ¡ˆ**: 
- æ£€æŸ¥ .gitignore æ–‡ä»¶æ˜¯å¦æ’é™¤äº† .kiro
- ä½¿ç”¨ `git add -f .kiro/` å¼ºåˆ¶æ·»åŠ 
- ç¡®ä¿æ–‡ä»¶å¤¹ä¸ä¸ºç©º

**ç›¸å…³æ–‡æ¡£**:
- `GitHubä¸Šä¼ é¡¹ç›®æŒ‡å—.md`
- `å¿«é€Ÿè§£å†³kiroæ–‡ä»¶å¤¹ä¸Šä¼ é—®é¢˜.md`
- `.gitignore.recommended`

---

### é—®é¢˜3: Dockeréƒ¨ç½²é”™è¯¯ âœ…
**é—®é¢˜**: è¿è¡Œ `docker-compose ps` åå‡ºç°ä¸¤ä¸ªé”™è¯¯
1. `ModuleNotFoundError: No module named 'psutil'`
2. `nginx: [emerg] cannot load certificate "/etc/nginx/ssl/cert.pem"`

**è§£å†³æ–¹æ¡ˆ**: 
1. æ·»åŠ  `psutil==5.9.6` åˆ° requirements.txt
2. ç”Ÿæˆè‡ªç­¾å SSL è¯ä¹¦
3. é‡æ–°æ„å»º Docker é•œåƒ

**å¿«é€Ÿä¿®å¤**:
```bash
cd /opt/sf-express
chmod +x fix_docker_deployment.sh
./fix_docker_deployment.sh
```

**ç›¸å…³æ–‡æ¡£**:
- `Dockeréƒ¨ç½²å¿«é€Ÿä¿®å¤æŒ‡å—.md`
- `Dockeréƒ¨ç½²é”™è¯¯ä¿®å¤æŒ‡å—.md`
- `Dockeréƒ¨ç½²é—®é¢˜å·²ä¿®å¤.md`
- `é—®é¢˜6_Dockeréƒ¨ç½²é”™è¯¯å·²ä¿®å¤.md`

---

## ğŸš€ å®Œæ•´éƒ¨ç½²æµç¨‹

### æ­¥éª¤1: å‡†å¤‡æœåŠ¡å™¨ç¯å¢ƒ

```bash
# æ›´æ–°ç³»ç»Ÿ
apt update && apt upgrade -y

# å®‰è£…åŸºç¡€å·¥å…·
apt install -y curl wget git vim net-tools

# å®‰è£…Dockerï¼ˆä½¿ç”¨å›½å†…é•œåƒï¼‰
curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun

# å¯åŠ¨Docker
systemctl start docker
systemctl enable docker

# å®‰è£…Docker Composeï¼ˆä½¿ç”¨å›½å†…é•œåƒï¼‰
curl -L https://get.daocloud.io/docker/compose/releases/download/v2.24.0/docker-compose-`uname -s`-`uname -m` > /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose
```

### æ­¥éª¤2: ä¸Šä¼ é¡¹ç›®æ–‡ä»¶

**æ–¹æ³•1: ä½¿ç”¨ SCP**
```bash
# åœ¨æœ¬åœ°æ‰“åŒ…é¡¹ç›®
cd /path/to/project
tar -czf sf-express.tar.gz sf-express/

# ä¸Šä¼ åˆ°æœåŠ¡å™¨
scp sf-express.tar.gz root@your-server-ip:/opt/

# åœ¨æœåŠ¡å™¨ä¸Šè§£å‹
ssh root@your-server-ip
cd /opt
tar -xzf sf-express.tar.gz
```

**æ–¹æ³•2: ä½¿ç”¨ WinSCP**
1. è¿æ¥åˆ°æœåŠ¡å™¨
2. ä¸Šä¼  sf-express æ–‡ä»¶å¤¹åˆ° /opt/

### æ­¥éª¤3: é…ç½®ç¯å¢ƒå˜é‡

```bash
cd /opt/sf-express

# å¤åˆ¶ç¯å¢ƒå˜é‡æ–‡ä»¶
cp .env.example .env.production

# ç¼–è¾‘é…ç½®
nano .env.production
```

**å¿…é¡»ä¿®æ”¹çš„é…ç½®**:
```bash
# æ•°æ®åº“å¯†ç ï¼ˆå¼ºå¯†ç ï¼‰
MYSQL_ROOT_PASSWORD=your-strong-root-password
MYSQL_PASSWORD=your-strong-user-password

# JWTå¯†é’¥ï¼ˆå¼ºå¯†é’¥ï¼‰
SECRET_KEY=your-very-strong-secret-key

# Rediså¯†ç 
REDIS_PASSWORD=your-redis-password

# å¿«é€’100 APIé…ç½®ï¼ˆä½¿ç”¨æ‚¨çš„å®é™…é…ç½®ï¼‰
KUAIDI100_KEY=your-key
KUAIDI100_CUSTOMER=your-customer
KUAIDI100_SECRET=your-secret
KUAIDI100_USERID=your-userid
```

### æ­¥éª¤4: è¿è¡Œä¿®å¤è„šæœ¬

```bash
cd /opt/sf-express

# æ·»åŠ æ‰§è¡Œæƒé™
chmod +x fix_docker_deployment.sh

# è¿è¡Œä¿®å¤è„šæœ¬
./fix_docker_deployment.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨å®Œæˆï¼š
- âœ… æ·»åŠ  psutil æ¨¡å—
- âœ… ç”Ÿæˆ SSL è¯ä¹¦
- âœ… æ„å»º Docker é•œåƒ
- âœ… å¯åŠ¨æ‰€æœ‰æœåŠ¡
- âœ… éªŒè¯æœåŠ¡çŠ¶æ€

### æ­¥éª¤5: éªŒè¯éƒ¨ç½²

```bash
# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker-compose --env-file .env.production ps

# æµ‹è¯•å¥åº·æ£€æŸ¥
curl http://localhost:8000/health

# æµ‹è¯•å‰ç«¯
curl http://localhost

# æŸ¥çœ‹æ—¥å¿—
docker-compose --env-file .env.production logs
```

### æ­¥éª¤6: é…ç½®é˜²ç«å¢™

```bash
# å¼€æ”¾å¿…è¦ç«¯å£
ufw allow 80/tcp
ufw allow 443/tcp
ufw allow 8000/tcp

# å¯ç”¨é˜²ç«å¢™
ufw enable
```

### æ­¥éª¤7: è®¿é—®åº”ç”¨

- **å‰ç«¯é¦–é¡µ**: `http://your-server-ip/`
- **ç®¡ç†åå°**: `http://your-server-ip/admin/login.html`
- **APIæ–‡æ¡£**: `http://your-server-ip:8000/docs`

**é»˜è®¤ç®¡ç†å‘˜è´¦å·**:
- ç”¨æˆ·å: `admin`
- å¯†ç : `admin123`

---

## ğŸ“ é¡¹ç›®æ–‡ä»¶ç»“æ„

```
sf-express/
â”œâ”€â”€ app/                          # åº”ç”¨ä»£ç 
â”‚   â”œâ”€â”€ api/                      # APIè·¯ç”±
â”‚   â”œâ”€â”€ core/                     # æ ¸å¿ƒé…ç½®
â”‚   â”œâ”€â”€ models/                   # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ schemas/                  # æ•°æ®æ¨¡å¼
â”‚   â””â”€â”€ services/                 # ä¸šåŠ¡é€»è¾‘
â”œâ”€â”€ static/                       # é™æ€æ–‡ä»¶
â”‚   â”œâ”€â”€ admin/                    # ç®¡ç†åå°
â”‚   â”œâ”€â”€ customer/                 # å®¢æˆ·ç«¯
â”‚   â””â”€â”€ templates/                # æ¨¡æ¿æ–‡ä»¶
â”œâ”€â”€ docker/                       # Dockeré…ç½®
â”‚   â”œâ”€â”€ nginx/                    # Nginxé…ç½®
â”‚   â”‚   â”œâ”€â”€ nginx.conf
â”‚   â”‚   â””â”€â”€ ssl/                  # SSLè¯ä¹¦
â”‚   â””â”€â”€ mysql/                    # MySQLåˆå§‹åŒ–
â”œâ”€â”€ alembic/                      # æ•°æ®åº“è¿ç§»
â”œâ”€â”€ scripts/                      # éƒ¨ç½²è„šæœ¬
â”œâ”€â”€ uploads/                      # ä¸Šä¼ æ–‡ä»¶
â”œâ”€â”€ requirements.txt              # Pythonä¾èµ–
â”œâ”€â”€ docker-compose.yml            # Dockerç¼–æ’
â”œâ”€â”€ Dockerfile                    # Dockeré•œåƒ
â”œâ”€â”€ .env.production               # ç”Ÿäº§ç¯å¢ƒé…ç½®
â””â”€â”€ fix_docker_deployment.sh     # ä¿®å¤è„šæœ¬
```

---

## ğŸ”§ å¸¸ç”¨å‘½ä»¤

### Docker ç®¡ç†

```bash
# æŸ¥çœ‹å®¹å™¨çŠ¶æ€
docker-compose --env-file .env.production ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose --env-file .env.production logs
docker-compose --env-file .env.production logs -f  # å®æ—¶æŸ¥çœ‹

# é‡å¯æœåŠ¡
docker-compose --env-file .env.production restart

# åœæ­¢æœåŠ¡
docker-compose --env-file .env.production down

# å¯åŠ¨æœåŠ¡
docker-compose --env-file .env.production up -d

# é‡æ–°æ„å»º
docker-compose --env-file .env.production build --no-cache
docker-compose --env-file .env.production up -d
```

### æ•°æ®åº“ç®¡ç†

```bash
# è¿›å…¥æ•°æ®åº“å®¹å™¨
docker-compose --env-file .env.production exec db bash

# è¿æ¥æ•°æ®åº“
mysql -u express_user -p express_tracking

# å¤‡ä»½æ•°æ®åº“
docker-compose --env-file .env.production exec db mysqldump -u express_user -p express_tracking > backup.sql

# æ¢å¤æ•°æ®åº“
docker-compose --env-file .env.production exec -T db mysql -u express_user -p express_tracking < backup.sql
```

### åº”ç”¨ç®¡ç†

```bash
# è¿›å…¥åº”ç”¨å®¹å™¨
docker-compose --env-file .env.production exec app bash

# æŸ¥çœ‹Pythonç‰ˆæœ¬
docker-compose --env-file .env.production exec app python --version

# è¿è¡Œæ•°æ®åº“è¿ç§»
docker-compose --env-file .env.production exec app alembic upgrade head

# åˆ›å»ºç®¡ç†å‘˜
docker-compose --env-file .env.production exec app python create_admin_user.py
```

### ç³»ç»Ÿç›‘æ§

```bash
# æŸ¥çœ‹å®¹å™¨èµ„æºä½¿ç”¨
docker stats

# æŸ¥çœ‹ç£ç›˜ç©ºé—´
df -h

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
free -h

# æŸ¥çœ‹ç«¯å£å ç”¨
netstat -tlnp
```

---

## ğŸ” æ•…éšœæ’æŸ¥

### å®¹å™¨æ— æ³•å¯åŠ¨

```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
docker-compose --env-file .env.production logs app
docker-compose --env-file .env.production logs nginx
docker-compose --env-file .env.production logs db

# æ£€æŸ¥é…ç½®æ–‡ä»¶
cat .env.production

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tlnp | grep :8000
netstat -tlnp | grep :80
netstat -tlnp | grep :3306
```

### æ•°æ®åº“è¿æ¥å¤±è´¥

```bash
# æ£€æŸ¥æ•°æ®åº“å®¹å™¨
docker-compose --env-file .env.production logs db

# æµ‹è¯•æ•°æ®åº“è¿æ¥
docker-compose --env-file .env.production exec db mysql -u express_user -p

# æ£€æŸ¥æ•°æ®åº“é…ç½®
docker-compose --env-file .env.production exec app env | grep DATABASE
```

### åº”ç”¨è®¿é—®å¤±è´¥

```bash
# æµ‹è¯•å¥åº·æ£€æŸ¥
curl http://localhost:8000/health

# æµ‹è¯•å‰ç«¯
curl http://localhost

# æ£€æŸ¥Nginxé…ç½®
docker-compose --env-file .env.production exec nginx nginx -t

# æŸ¥çœ‹Nginxæ—¥å¿—
docker-compose --env-file .env.production logs nginx
```

### ç£ç›˜ç©ºé—´ä¸è¶³

```bash
# æŸ¥çœ‹ç£ç›˜ä½¿ç”¨
df -h

# æ¸…ç†Docker
docker system prune -a
docker volume prune

# æ¸…ç†æ—¥å¿—
find /var/lib/docker/containers/ -name "*.log" -exec truncate -s 0 {} \;
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. æ•°æ®åº“ä¼˜åŒ–

```bash
# ç¼–è¾‘MySQLé…ç½®
nano docker/mysql/my.cnf
```

æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š
```ini
[mysqld]
max_connections = 200
innodb_buffer_pool_size = 1G
innodb_log_file_size = 256M
query_cache_size = 64M
```

### 2. åº”ç”¨ä¼˜åŒ–

ä¿®æ”¹ `docker-compose.yml` ä¸­çš„ workers æ•°é‡ï¼š
```yaml
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--workers", "4"]
```

### 3. Nginxä¼˜åŒ–

ç¼–è¾‘ `docker/nginx/nginx.conf`ï¼š
```nginx
worker_processes auto;
worker_connections 1024;
keepalive_timeout 65;
gzip on;
gzip_types text/plain text/css application/json application/javascript;
```

---

## ğŸ” å®‰å…¨åŠ å›º

### 1. ä¿®æ”¹é»˜è®¤å¯†ç 

```bash
# ä¿®æ”¹ç®¡ç†å‘˜å¯†ç 
docker-compose --env-file .env.production exec app python -c "
from app.core.security import get_password_hash
print(get_password_hash('new-password'))
"

# æ›´æ–°æ•°æ®åº“
docker-compose --env-file .env.production exec db mysql -u express_user -p express_tracking -e "
UPDATE admin_users SET password_hash='<new-hash>' WHERE username='admin';
"
```

### 2. é…ç½®SSLè¯ä¹¦

ä½¿ç”¨ Let's Encrypt è·å–å…è´¹SSLè¯ä¹¦ï¼š
```bash
# å®‰è£…certbot
apt install -y certbot

# è·å–è¯ä¹¦
certbot certonly --standalone -d your-domain.com

# å¤åˆ¶è¯ä¹¦
cp /etc/letsencrypt/live/your-domain.com/fullchain.pem docker/nginx/ssl/cert.pem
cp /etc/letsencrypt/live/your-domain.com/privkey.pem docker/nginx/ssl/key.pem

# é‡å¯Nginx
docker-compose --env-file .env.production restart nginx
```

### 3. é…ç½®é˜²ç«å¢™

```bash
# åªå…è®¸å¿…è¦ç«¯å£
ufw default deny incoming
ufw default allow outgoing
ufw allow ssh
ufw allow 80/tcp
ufw allow 443/tcp
ufw enable
```

---

## ğŸ“ ç›¸å…³æ–‡æ¡£ç´¢å¼•

### éƒ¨ç½²æ–‡æ¡£
- `é˜¿é‡Œäº‘æœåŠ¡å™¨éƒ¨ç½²æŒ‡å—.md` - å®Œæ•´éƒ¨ç½²æŒ‡å—ï¼ˆ8000+å­—ï¼‰
- `é˜¿é‡Œäº‘éƒ¨ç½²å¿«é€Ÿå‚è€ƒ.md` - å¿«é€Ÿå‚è€ƒå¡
- `éƒ¨ç½²æ£€æŸ¥æ¸…å•.md` - 100+é¡¹æ£€æŸ¥æ¸…å•
- `é˜¿é‡Œäº‘éƒ¨ç½²æ–‡æ¡£æ€»ç»“.md` - æ–‡æ¡£å¯¼èˆª

### é—®é¢˜è§£å†³
- `GitHubè®¿é—®é—®é¢˜è§£å†³æ–¹æ¡ˆ.md` - GitHubè®¿é—®é—®é¢˜
- `å¿«é€Ÿè§£å†³GitHubè®¿é—®é—®é¢˜.md` - GitHubå¿«é€Ÿè§£å†³
- `GitHubä¸Šä¼ é¡¹ç›®æŒ‡å—.md` - GitHubä¸Šä¼ æŒ‡å—
- `å¿«é€Ÿè§£å†³kiroæ–‡ä»¶å¤¹ä¸Šä¼ é—®é¢˜.md` - .kiroæ–‡ä»¶å¤¹ä¸Šä¼ 

### Dockeréƒ¨ç½²
- `Dockeréƒ¨ç½²å¿«é€Ÿä¿®å¤æŒ‡å—.md` - å¿«é€Ÿä¿®å¤æŒ‡å—
- `Dockeréƒ¨ç½²é”™è¯¯ä¿®å¤æŒ‡å—.md` - è¯¦ç»†ä¿®å¤è¯´æ˜
- `Dockeréƒ¨ç½²é—®é¢˜å·²ä¿®å¤.md` - ä¿®å¤æ€»ç»“
- `é—®é¢˜6_Dockeréƒ¨ç½²é”™è¯¯å·²ä¿®å¤.md` - é—®é¢˜è®°å½•

### é¡¹ç›®æ–‡æ¡£
- `sf-express/README.md` - é¡¹ç›®è¯´æ˜
- `sf-express/é¡¹ç›®è¯´æ˜.md` - è¯¦ç»†é¡¹ç›®è¯´æ˜
- `sf-express/DEPLOYMENT.md` - éƒ¨ç½²æ–‡æ¡£

---

## ğŸ¯ éƒ¨ç½²æ£€æŸ¥æ¸…å•

### æœåŠ¡å™¨å‡†å¤‡
- [ ] æœåŠ¡å™¨å·²è´­ä¹°å¹¶å¯è®¿é—®
- [ ] å·²å®‰è£… Docker
- [ ] å·²å®‰è£… Docker Compose
- [ ] é˜²ç«å¢™å·²é…ç½®
- [ ] ç£ç›˜ç©ºé—´å……è¶³ï¼ˆè‡³å°‘10GBï¼‰

### é¡¹ç›®é…ç½®
- [ ] é¡¹ç›®æ–‡ä»¶å·²ä¸Šä¼ 
- [ ] .env.production å·²é…ç½®
- [ ] æ•°æ®åº“å¯†ç å·²ä¿®æ”¹
- [ ] JWTå¯†é’¥å·²ä¿®æ”¹
- [ ] å¿«é€’100 APIå·²é…ç½®

### Dockeréƒ¨ç½²
- [ ] requirements.txt åŒ…å« psutil
- [ ] SSLè¯ä¹¦å·²ç”Ÿæˆ
- [ ] Dockeré•œåƒå·²æ„å»º
- [ ] æ‰€æœ‰å®¹å™¨æ­£å¸¸è¿è¡Œ
- [ ] å¥åº·æ£€æŸ¥é€šè¿‡

### åŠŸèƒ½æµ‹è¯•
- [ ] å‰ç«¯é¡µé¢å¯è®¿é—®
- [ ] ç®¡ç†åå°å¯ç™»å½•
- [ ] APIæ–‡æ¡£å¯è®¿é—®
- [ ] ç†è´§å•ä¸Šä¼ åŠŸèƒ½æ­£å¸¸
- [ ] ç‰©æµæŸ¥è¯¢åŠŸèƒ½æ­£å¸¸

### å®‰å…¨é…ç½®
- [ ] ç®¡ç†å‘˜å¯†ç å·²ä¿®æ”¹
- [ ] æ•°æ®åº“å¯†ç å·²ä¿®æ”¹
- [ ] é˜²ç«å¢™å·²å¯ç”¨
- [ ] SSLè¯ä¹¦å·²é…ç½®ï¼ˆå¯é€‰ï¼‰

---

## ğŸ‰ éƒ¨ç½²æˆåŠŸæ ‡å¿—

å½“æ‚¨çœ‹åˆ°ä»¥ä¸‹ç»“æœæ—¶ï¼Œè¯´æ˜éƒ¨ç½²å®Œå…¨æˆåŠŸï¼š

1. âœ… æ‰€æœ‰Dockerå®¹å™¨çŠ¶æ€ä¸º `Up`
2. âœ… å¥åº·æ£€æŸ¥è¿”å› `{"status":"ok"}`
3. âœ… å‰ç«¯é¡µé¢å¯ä»¥æ­£å¸¸è®¿é—®
4. âœ… ç®¡ç†åå°å¯ä»¥ç™»å½•
5. âœ… ç†è´§å•å¯ä»¥ä¸Šä¼ 
6. âœ… ç‰©æµä¿¡æ¯å¯ä»¥æŸ¥è¯¢
7. âœ… æ—¥å¿—ä¸­æ²¡æœ‰é”™è¯¯ä¿¡æ¯
8. âœ… ç³»ç»Ÿèµ„æºä½¿ç”¨æ­£å¸¸

---

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **å®¹å™¨çŠ¶æ€**:
   ```bash
   docker-compose --env-file .env.production ps
   ```

2. **åº”ç”¨æ—¥å¿—**:
   ```bash
   docker-compose --env-file .env.production logs app | tail -100
   ```

3. **Nginxæ—¥å¿—**:
   ```bash
   docker-compose --env-file .env.production logs nginx | tail -100
   ```

4. **ç³»ç»Ÿä¿¡æ¯**:
   ```bash
   df -h
   free -h
   docker stats --no-stream
   ```

---

**æœ€åæ›´æ–°**: 2026-02-02  
**ç‰ˆæœ¬**: 1.0  
**çŠ¶æ€**: âœ… æ‰€æœ‰é—®é¢˜å·²è§£å†³
