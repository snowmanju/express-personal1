# 登录跳转修复说明

## 问题描述

用户使用 `admin/admin123` 登录成功后，页面没有跳转到管理后台仪表板。

## 问题原因

在 `static/admin/js/admin-dashboard.js` 文件中发现两个问题：

### 1. 重定向路径错误
所有的重定向路径都使用了错误的路径：
- 错误路径: `/static/admin/login.html`
- 正确路径: `/admin/login.html`

这是因为在 `app/main.py` 中，管理后台的静态文件是通过以下方式挂载的：

```python
app.mount("/admin", StaticFiles(directory="static/admin", html=True), name="admin")
```

这意味着 `static/admin/` 目录下的文件会被映射到 `/admin/` 路径，而不是 `/static/admin/`。

### 2. API端点路径错误
Token验证API端点路径错误：
- 错误路径: `/api/v1/admin/auth/me`
- 正确路径: `/api/v1/admin/me`

在 `app/api/v1/api.py` 中，auth路由器是这样注册的：

```python
api_router.include_router(auth.router, prefix="/admin", tags=["admin", "auth"])
```

所以 auth.py 中的 `/me` 端点实际路径是 `/api/v1/admin/me`，而不是 `/api/v1/admin/auth/me`。

## 修复内容

修改了 `static/admin/js/admin-dashboard.js` 文件中的四个函数：

### 1. checkAuth() 函数
- 修复了API端点路径：`/api/v1/admin/auth/me` → `/api/v1/admin/me`
- 修复了未认证时的重定向路径
- 添加了对 `sessionStorage` 的支持（配合登录页的"记住我"功能）

```javascript
// 修改前
const response = await fetch('/api/v1/admin/auth/me', {
    headers: { 'Authorization': `Bearer ${token}` }
});
window.location.href = '/static/admin/login.html';

// 修改后
const response = await fetch('/api/v1/admin/me', {
    headers: { 'Authorization': `Bearer ${token}` }
});
window.location.href = '/admin/login.html';
```

### 2. logout() 函数
- 修复了退出登录时的重定向路径
- 添加了清除 `sessionStorage` 的逻辑

```javascript
// 修改前
window.location.href = '/static/admin/login.html';

// 修改后
window.location.href = '/admin/login.html';
```

### 3. apiRequest() 函数
- 修复了401未授权时的重定向路径
- 添加了对 `sessionStorage` 的支持

```javascript
// 修改前
window.location.href = '/static/admin/login.html';

// 修改后
window.location.href = '/admin/login.html';
```

## 测试结果

运行 `python test_login_redirect.py` 的测试结果：

```
1. 测试登录API...
   状态码: 200
   ✓ 登录成功

2. 测试验证token...
   状态码: 200
   ✓ Token验证成功
   用户名: admin

3. 测试访问仪表板页面...
   状态码: 200
   ✓ 仪表板页面可访问
   ✓ 页面包含正确的标题
   ✓ 页面引用了JavaScript文件

4. 测试访问登录页面...
   状态码: 200
   ✓ 登录页面可访问
   ✓ 页面包含正确的标题
   ✓ 页面包含正确的跳转路径
```

所有测试通过！✅

## 测试方法

### 方法1: 自动化测试
运行测试脚本：
```bash
python test_login_redirect.py
```

### 方法2: 手动测试
1. 确保服务器正在运行：
   ```bash
   python run.py
   ```

2. 在浏览器中访问登录页面：
   ```
   http://localhost:8000/admin/login.html
   ```

3. 使用以下凭据登录：
   - 用户名: `admin`
   - 密码: `admin123`

4. 点击"登录"按钮

5. 验证结果：
   - 应该看到"登录成功！正在跳转..."的提示
   - 1秒后自动跳转到管理后台仪表板
   - 仪表板URL应该是: `http://localhost:8000/admin/dashboard.html`
   - 仪表板应该显示统计数据和管理功能

## 相关文件

- `static/admin/js/admin-dashboard.js` - 修复了API端点和重定向路径
- `static/admin/login.html` - 登录页面（已正确配置跳转路径）
- `app/main.py` - 静态文件挂载配置
- `app/api/v1/api.py` - API路由配置
- `test_login_redirect.py` - 测试脚本

## 注意事项

1. **路径规则**：
   - 前台页面: `/` 或 `/static/xxx`
   - 管理后台: `/admin/xxx`
   - 客户端: `/customer/xxx`
   - API接口: `/api/v1/xxx`

2. **API端点结构**：
   - 登录: `/api/v1/admin/login`
   - 获取当前用户: `/api/v1/admin/me`
   - 理货单管理: `/api/v1/admin/manifest/xxx`
   - 数据同步: `/api/v1/admin/sync/xxx`

3. **Token存储**：
   - 勾选"记住我": Token存储在 `localStorage`（持久化）
   - 不勾选"记住我": Token存储在 `sessionStorage`（关闭浏览器后清除）

4. **认证流程**：
   - 登录成功 → 保存Token → 跳转到仪表板
   - 访问仪表板 → 检查Token → 验证Token → 加载数据
   - Token无效 → 清除Token → 跳转到登录页

## 修复状态

✅ 已修复 - 登录后现在可以正确跳转到管理后台仪表板
✅ 已测试 - 所有自动化测试通过
