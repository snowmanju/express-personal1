<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>快递查询网站</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            margin-top: 2rem;
            margin-bottom: 2rem;
            padding: 2rem;
        }
        
        .query-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .result-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            padding: 2rem;
            margin-top: 2rem;
            display: none;
        }
        
        .tracking-input {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 1rem;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
        
        .tracking-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .query-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .query-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .query-btn:disabled {
            background: #6c757d;
            transform: none;
            box-shadow: none;
        }
        
        .clear-btn {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
        }
        
        .clear-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
            color: #495057;
        }
        
        .loading-spinner {
            display: none;
            margin: 0 auto;
        }
        
        .error-alert {
            border-radius: 10px;
            border: none;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
        }
        
        .success-alert {
            border-radius: 10px;
            border: none;
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
            color: white;
        }
        
        .info-alert {
            border-radius: 10px;
            border: none;
            background: linear-gradient(135deg, #339af0 0%, #228be6 100%);
            color: white;
        }
        
        .tracking-status {
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        
        .status-delivered {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
            color: white;
        }
        
        .status-transit {
            background: linear-gradient(135deg, #339af0 0%, #228be6 100%);
            color: white;
        }
        
        .status-pending {
            background: linear-gradient(135deg, #ffd43b 0%, #fab005 100%);
            color: #495057;
        }
        
        .status-exception {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
        }
        
        .timeline {
            position: relative;
            padding-left: 2rem;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 1rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #dee2e6;
        }
        
        .timeline-item {
            position: relative;
            padding: 1rem 0;
            margin-left: 1rem;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -1.5rem;
            top: 1.5rem;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #667eea;
            border: 3px solid white;
            box-shadow: 0 0 0 3px #dee2e6;
        }
        
        .timeline-item:first-child::before {
            background: #51cf66;
            box-shadow: 0 0 0 3px #51cf66;
        }
        
        .timeline-content {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .timeline-item:first-child .timeline-content {
            border-left-color: #51cf66;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @media (max-width: 768px) {
            .main-container {
                margin: 1rem;
                padding: 1rem;
            }
            
            .query-card, .result-card {
                padding: 1.5rem;
            }
            
            .tracking-input {
                font-size: 1rem;
                padding: 0.8rem;
            }
            
            .query-btn, .clear-btn {
                font-size: 1rem;
                padding: 0.8rem 1.5rem;
                width: 100%;
                margin-bottom: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-container">
            <!-- Header -->
            <div class="text-center mb-4">
                <h1 class="display-4 fw-bold text-primary mb-3">
                    <i class="bi bi-truck"></i> 快递查询网站
                </h1>
                <p class="lead text-muted">
                    输入快递单号，快速查询物流信息
                </p>
            </div>
            
            <!-- Query Form -->
            <div class="query-card">
                <form id="trackingForm">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-8">
                            <label for="trackingNumber" class="form-label fw-semibold">
                                <i class="bi bi-box-seam"></i> 快递单号
                            </label>
                            <input 
                                type="text" 
                                class="form-control tracking-input" 
                                id="trackingNumber" 
                                name="trackingNumber"
                                placeholder="请输入快递单号，如：1234567890"
                                maxlength="50"
                                autocomplete="off"
                                required
                            >
                            <div class="invalid-feedback" id="trackingNumberError"></div>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn query-btn w-100" id="queryBtn">
                                <span class="btn-text">
                                    <i class="bi bi-search"></i> 查询
                                </span>
                                <div class="spinner-border spinner-border-sm loading-spinner" role="status">
                                    <span class="visually-hidden">查询中...</span>
                                </div>
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn clear-btn w-100" id="clearBtn">
                                <i class="bi bi-arrow-clockwise"></i> 清空
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Alert Messages -->
            <div id="alertContainer"></div>
            
            <!-- Results -->
            <div class="result-card" id="resultCard">
                <div id="resultContent"></div>
            </div>
            
            <!-- Footer -->
            <div class="text-center mt-4 pt-4 border-top">
                <p class="text-muted small">
                    <i class="bi bi-shield-check"></i> 
                    支持主要快递公司查询 | 数据实时更新 | 
                    <a href="/docs" class="text-decoration-none">API文档</a>
                </p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        class TrackingApp {
            constructor() {
                this.form = document.getElementById('trackingForm');
                this.trackingInput = document.getElementById('trackingNumber');
                this.queryBtn = document.getElementById('queryBtn');
                this.clearBtn = document.getElementById('clearBtn');
                this.alertContainer = document.getElementById('alertContainer');
                this.resultCard = document.getElementById('resultCard');
                this.resultContent = document.getElementById('resultContent');
                
                this.initEventListeners();
                this.initInputValidation();
            }
            
            initEventListeners() {
                // Form submission
                this.form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleQuery();
                });
                
                // Clear button
                this.clearBtn.addEventListener('click', () => {
                    this.clearForm();
                });
                
                // Input validation on typing
                this.trackingInput.addEventListener('input', () => {
                    this.validateInput();
                });
                
                // Enter key handling
                this.trackingInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.handleQuery();
                    }
                });
            }
            
            initInputValidation() {
                // Real-time input validation
                this.trackingInput.addEventListener('blur', () => {
                    this.validateInput(true);
                });
            }
            
            validateInput(showErrors = false) {
                const value = this.trackingInput.value.trim();
                const errorElement = document.getElementById('trackingNumberError');
                
                // Clear previous validation state
                this.trackingInput.classList.remove('is-invalid', 'is-valid');
                errorElement.textContent = '';
                
                if (!value) {
                    if (showErrors) {
                        this.trackingInput.classList.add('is-invalid');
                        errorElement.textContent = '请输入快递单号';
                    }
                    return false;
                }
                
                // Basic format validation
                if (value.length < 6) {
                    if (showErrors) {
                        this.trackingInput.classList.add('is-invalid');
                        errorElement.textContent = '快递单号长度不能少于6位';
                    }
                    return false;
                }
                
                if (!/^[A-Za-z0-9]+$/.test(value)) {
                    if (showErrors) {
                        this.trackingInput.classList.add('is-invalid');
                        errorElement.textContent = '快递单号只能包含字母和数字';
                    }
                    return false;
                }
                
                this.trackingInput.classList.add('is-valid');
                return true;
            }
            
            async handleQuery() {
                if (!this.validateInput(true)) {
                    return;
                }
                
                const trackingNumber = this.trackingInput.value.trim();
                
                try {
                    this.setLoadingState(true);
                    this.clearAlerts();
                    this.hideResults();
                    
                    const response = await this.queryTracking(trackingNumber);
                    
                    if (response.success) {
                        this.showSuccess('查询成功！');
                        this.displayResults(response);
                    } else {
                        this.showError(response.error || '查询失败，请稍后重试');
                    }
                    
                } catch (error) {
                    console.error('Query error:', error);
                    this.showError('网络错误或服务暂时不可用，请稍后重试');
                } finally {
                    this.setLoadingState(false);
                }
            }
            
            async queryTracking(trackingNumber) {
                const response = await fetch('/api/v1/tracking/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        tracking_number: trackingNumber,
                        company_code: 'auto'
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }
                
                return await response.json();
            }
            
            displayResults(data) {
                const html = this.generateResultsHTML(data);
                this.resultContent.innerHTML = html;
                this.resultCard.style.display = 'block';
                this.resultCard.classList.add('fade-in');
                
                // Scroll to results
                setTimeout(() => {
                    this.resultCard.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 100);
            }
            
            generateResultsHTML(data) {
                let html = `
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5 class="fw-bold mb-3">
                                <i class="bi bi-info-circle"></i> 查询信息
                            </h5>
                            <div class="table-responsive">
                                <table class="table table-borderless">
                                    <tbody>
                                        <tr>
                                            <td class="fw-semibold">原始单号:</td>
                                            <td><code>${data.original_tracking_number}</code></td>
                                        </tr>
                                        <tr>
                                            <td class="fw-semibold">查询单号:</td>
                                            <td><code>${data.query_tracking_number}</code></td>
                                        </tr>
                                        <tr>
                                            <td class="fw-semibold">查询类型:</td>
                                            <td>
                                                <span class="badge ${data.query_type === 'package' ? 'bg-info' : 'bg-secondary'}">
                                                    ${data.query_type === 'package' ? '集包查询' : '直接查询'}
                                                </span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="fw-semibold">集包关联:</td>
                                            <td>
                                                <span class="badge ${data.has_package_association ? 'bg-success' : 'bg-secondary'}">
                                                    ${data.has_package_association ? '是' : '否'}
                                                </span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-6">
                            ${this.generateManifestInfoHTML(data.manifest_info)}
                        </div>
                    </div>
                `;
                
                if (data.tracking_info) {
                    html += this.generateTrackingInfoHTML(data.tracking_info);
                } else {
                    html += `
                        <div class="alert info-alert">
                            <i class="bi bi-info-circle"></i>
                            暂无物流跟踪信息，请稍后重试或联系快递公司
                        </div>
                    `;
                }
                
                return html;
            }
            
            generateManifestInfoHTML(manifestInfo) {
                if (!manifestInfo) {
                    return `
                        <h5 class="fw-bold mb-3">
                            <i class="bi bi-box"></i> 理货信息
                        </h5>
                        <div class="alert info-alert">
                            <i class="bi bi-info-circle"></i>
                            无理货单信息
                        </div>
                    `;
                }
                
                return `
                    <h5 class="fw-bold mb-3">
                        <i class="bi bi-box"></i> 理货信息
                    </h5>
                    <div class="table-responsive">
                        <table class="table table-borderless">
                            <tbody>
                                ${manifestInfo.transport_code ? `
                                    <tr>
                                        <td class="fw-semibold">运输代码:</td>
                                        <td>${manifestInfo.transport_code}</td>
                                    </tr>
                                ` : ''}
                                ${manifestInfo.customer_code ? `
                                    <tr>
                                        <td class="fw-semibold">客户代码:</td>
                                        <td>${manifestInfo.customer_code}</td>
                                    </tr>
                                ` : ''}
                                ${manifestInfo.goods_code ? `
                                    <tr>
                                        <td class="fw-semibold">货物代码:</td>
                                        <td>${manifestInfo.goods_code}</td>
                                    </tr>
                                ` : ''}
                                ${manifestInfo.weight ? `
                                    <tr>
                                        <td class="fw-semibold">重量:</td>
                                        <td>${manifestInfo.weight} kg</td>
                                    </tr>
                                ` : ''}
                                ${manifestInfo.dimensions ? `
                                    <tr>
                                        <td class="fw-semibold">尺寸:</td>
                                        <td>${manifestInfo.dimensions}</td>
                                    </tr>
                                ` : ''}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            generateTrackingInfoHTML(trackingInfo) {
                let html = `
                    <div class="mb-4">
                        <h5 class="fw-bold mb-3">
                            <i class="bi bi-truck"></i> 物流状态
                        </h5>
                `;
                
                // Status display
                if (trackingInfo.state) {
                    const statusClass = this.getStatusClass(trackingInfo.state);
                    const statusText = this.getStatusText(trackingInfo.state);
                    
                    html += `
                        <div class="tracking-status ${statusClass}">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-circle-fill me-2"></i>
                                <span class="fs-5 fw-bold">${statusText}</span>
                            </div>
                        </div>
                    `;
                }
                
                // Company info
                if (trackingInfo.com || trackingInfo.company) {
                    html += `
                        <div class="mb-3">
                            <span class="badge bg-primary fs-6">
                                <i class="bi bi-building"></i> 
                                ${trackingInfo.company || trackingInfo.com}
                            </span>
                        </div>
                    `;
                }
                
                html += `</div>`;
                
                // Tracking timeline
                if (trackingInfo.data && trackingInfo.data.length > 0) {
                    html += `
                        <div class="mb-4">
                            <h5 class="fw-bold mb-3">
                                <i class="bi bi-clock-history"></i> 物流轨迹
                            </h5>
                            <div class="timeline">
                    `;
                    
                    trackingInfo.data.forEach((item, index) => {
                        html += `
                            <div class="timeline-item">
                                <div class="timeline-content">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <span class="fw-semibold text-primary">${item.time || '时间未知'}</span>
                                        ${index === 0 ? '<span class="badge bg-success">最新</span>' : ''}
                                    </div>
                                    <p class="mb-1">${item.context || '无描述信息'}</p>
                                    ${item.location ? `<small class="text-muted"><i class="bi bi-geo-alt"></i> ${item.location}</small>` : ''}
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="alert info-alert">
                            <i class="bi bi-info-circle"></i>
                            暂无详细物流轨迹信息
                        </div>
                    `;
                }
                
                return html;
            }
            
            getStatusClass(state) {
                switch (state) {
                    case '3': return 'status-delivered';
                    case '1': case '2': return 'status-transit';
                    case '0': return 'status-pending';
                    default: return 'status-exception';
                }
            }
            
            getStatusText(state) {
                switch (state) {
                    case '0': return '待揽收';
                    case '1': return '运输中';
                    case '2': return '派送中';
                    case '3': return '已签收';
                    case '4': return '派送异常';
                    case '5': return '疑难件';
                    case '6': return '退件签收';
                    default: return '状态未知';
                }
            }
            
            setLoadingState(loading) {
                const btnText = this.queryBtn.querySelector('.btn-text');
                const spinner = this.queryBtn.querySelector('.loading-spinner');
                
                if (loading) {
                    this.queryBtn.disabled = true;
                    btnText.style.display = 'none';
                    spinner.style.display = 'inline-block';
                    this.queryBtn.classList.add('pulse');
                } else {
                    this.queryBtn.disabled = false;
                    btnText.style.display = 'inline';
                    spinner.style.display = 'none';
                    this.queryBtn.classList.remove('pulse');
                }
            }
            
            clearForm() {
                this.trackingInput.value = '';
                this.trackingInput.classList.remove('is-invalid', 'is-valid');
                document.getElementById('trackingNumberError').textContent = '';
                this.clearAlerts();
                this.hideResults();
                this.trackingInput.focus();
            }
            
            hideResults() {
                this.resultCard.style.display = 'none';
                this.resultCard.classList.remove('fade-in');
            }
            
            clearAlerts() {
                this.alertContainer.innerHTML = '';
            }
            
            showAlert(message, type, icon) {
                const alertHTML = `
                    <div class="alert ${type}-alert alert-dismissible fade show" role="alert">
                        <i class="bi bi-${icon}"></i>
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                this.alertContainer.innerHTML = alertHTML;
                
                // Auto dismiss after 5 seconds
                setTimeout(() => {
                    const alert = this.alertContainer.querySelector('.alert');
                    if (alert) {
                        const bsAlert = new bootstrap.Alert(alert);
                        bsAlert.close();
                    }
                }, 5000);
            }
            
            showSuccess(message) {
                this.showAlert(message, 'success', 'check-circle');
            }
            
            showError(message) {
                this.showAlert(message, 'error', 'exclamation-triangle');
            }
            
            showInfo(message) {
                this.showAlert(message, 'info', 'info-circle');
            }
        }
        
        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new TrackingApp();
        });
        
        // Add some utility functions for better UX
        
        // Prevent form submission on Enter in input fields (handled by app)
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.target.tagName === 'INPUT') {
                e.preventDefault();
            }
        });
        
        // Add loading animation to page
        window.addEventListener('load', () => {
            document.body.style.opacity = '0';
            document.body.style.transition = 'opacity 0.3s ease';
            setTimeout(() => {
                document.body.style.opacity = '1';
            }, 100);
        });
    </script>
</body>
</html>