# SF Express 快递查询系统 - 项目说明

## 📁 项目结构

```
sf-express/
├── app/                          # 应用核心代码
│   ├── api/                     # API路由
│   │   └── v1/                  # API v1版本
│   │       ├── auth.py          # 认证接口
│   │       ├── tracking.py      # 快递查询接口
│   │       ├── manifest.py      # 理货单管理接口
│   │       └── sync.py          # 数据同步接口
│   ├── core/                    # 核心配置
│   │   ├── config_simple.py     # 配置文件
│   │   ├── database.py          # 数据库连接
│   │   └── security.py          # 安全相关
│   ├── models/                  # 数据模型
│   │   ├── admin_user.py        # 管理员模型
│   │   └── manifest.py          # 理货单模型
│   ├── schemas/                 # 数据模式
│   │   ├── auth.py              # 认证模式
│   │   ├── tracking.py          # 查询模式
│   │   └── manifest.py          # 理货单模式
│   ├── services/                # 业务逻辑
│   │   ├── kuaidi100_client.py  # 快递100客户端
│   │   ├── intelligent_query_service.py  # 智能查询服务
│   │   ├── csv_processor.py     # CSV处理
│   │   ├── file_validator.py    # 文件验证
│   │   ├── data_validator.py    # 数据验证
│   │   └── manifest_storage.py  # 理货单存储
│   └── main.py                  # 应用入口
│
├── static/                       # 静态文件
│   ├── admin/                   # 管理后台
│   │   ├── login.html           # 登录页面
│   │   ├── dashboard.html       # 仪表板
│   │   └── js/                  # JavaScript文件
│   ├── customer/                # 客户端页面
│   │   ├── login.html           # 客户登录
│   │   └── register.html        # 客户注册
│   ├── templates/               # 模板文件
│   │   ├── 理货单上传模板.csv   # CSV模板
│   │   └── 理货单上传模板.xlsx  # Excel模板
│   └── index_tech.html          # 首页
│
├── alembic/                     # 数据库迁移
│   ├── versions/                # 迁移版本
│   └── env.py                   # 迁移环境
│
├── tests/                       # 测试文件
│   ├── setup_database.py        # 数据库初始化
│   ├── create_admin_user.py     # 创建管理员
│   ├── create_test_data.py      # 创建测试数据
│   ├── test_template_upload.py  # 测试模板上传
│   └── create_excel_template.py # 创建Excel模板
│
├── tools/                       # 工具脚本
│   ├── check_mysql_service.py   # 检查MySQL服务
│   ├── start_mysql.py           # 启动MySQL
│   ├── quick_diagnose.py        # 快速诊断
│   └── diagnose_server.py       # 服务器诊断
│
├── docs/                        # 文档
│   ├── 快速启动指南.md          # 快速开始
│   ├── 平台测试指南.md          # 测试指南
│   └── 理货单模板说明_最终版.md # 模板说明
│
├── uploads/                     # 上传文件目录
├── scripts/                     # 部署脚本
├── docker/                      # Docker配置
│
├── .env                         # 环境配置（需配置）
├── .env.example                 # 环境配置示例
├── .gitignore                   # Git忽略文件
├── requirements.txt             # Python依赖
├── run.py                       # 启动脚本
├── alembic.ini                  # Alembic配置
├── Dockerfile                   # Docker镜像
├── docker-compose.yml           # Docker编排
├── README.md                    # 项目说明
└── DEPLOYMENT.md                # 部署文档
```

## 🚀 快速开始

### 1. 环境要求

- Python 3.8+
- MySQL 8.0+
- pip

### 2. 安装依赖

```bash
cd sf-express
pip install -r requirements.txt
```

### 3. 配置环境

复制 `.env.example` 为 `.env`，修改配置：

```env
# 数据库配置
DATABASE_URL=mysql+pymysql://root:your_password@localhost:3306/express_tracking

# 快递100 API配置
KUAIDI100_CUSTOMER=your_customer_id
KUAIDI100_KEY=your_api_key

# JWT配置
SECRET_KEY=your_secret_key
```

### 4. 初始化数据库

```bash
# 创建数据库和表
python tests/setup_database.py

# 创建管理员账号
python tests/create_admin_user.py
```

### 5. 启动服务

```bash
python run.py
```

访问：http://localhost:8000

## 📋 功能模块

### 1. 快递查询
- 智能单号识别
- 多快递公司支持
- 实时物流信息

### 2. 理货单管理
- 批量上传（CSV/Excel）
- 数据验证
- 预览模式
- 统计分析

### 3. 管理后台
- 用户认证
- 数据管理
- 文件上传
- 统计报表

### 4. 数据同步
- 自动同步
- 增量更新
- 错误重试

## 🔧 配置说明

### 数据库配置

在 `.env` 文件中配置：

```env
DATABASE_URL=mysql+pymysql://用户名:密码@主机:端口/数据库名
```

### API配置

快递100 API配置：

```env
KUAIDI100_CUSTOMER=客户编号
KUAIDI100_KEY=API密钥
```

### 安全配置

JWT密钥配置：

```env
SECRET_KEY=随机生成的密钥
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30
```

## 📝 使用说明

### 管理员登录

1. 访问：http://localhost:8000/admin/login.html
2. 默认账号：admin / admin123
3. 登录后进入管理后台

### 上传理货单

1. 下载模板：http://localhost:8000/static/templates/理货单上传模板.csv
2. 填写数据（不要修改列名）
3. 登录后台上传
4. 建议先使用预览模式

### 查询快递

1. 访问首页：http://localhost:8000
2. 输入快递单号
3. 点击查询
4. 查看物流信息

## 🧪 测试

### 运行测试

```bash
# 测试模板上传
python tests/test_template_upload.py

# 创建测试数据
python tests/create_test_data.py
```

### 诊断工具

```bash
# 检查MySQL服务
python tools/check_mysql_service.py

# 快速诊断
python tools/quick_diagnose.py

# 服务器诊断
python tools/diagnose_server.py
```

## 📚 文档

- [快速启动指南](docs/快速启动指南.md) - 详细的启动步骤
- [平台测试指南](docs/平台测试指南.md) - 测试用例和方法
- [理货单模板说明](docs/理货单模板说明_最终版.md) - 模板使用说明

## 🐳 Docker部署

### 使用Docker Compose

```bash
# 启动所有服务
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down
```

### 单独构建

```bash
# 构建镜像
docker build -t sf-express .

# 运行容器
docker run -p 8000:8000 sf-express
```

## 🔍 故障排查

### 常见问题

1. **数据库连接失败**
   - 检查MySQL服务是否启动
   - 检查 `.env` 中的数据库配置
   - 运行：`python tools/check_mysql_service.py`

2. **登录后无法跳转**
   - 清除浏览器缓存
   - 检查浏览器控制台错误
   - 使用无痕模式测试

3. **文件上传失败**
   - 检查文件格式（CSV/Excel）
   - 检查列名是否匹配模板
   - 使用预览模式测试

4. **快递查询无结果**
   - 检查快递100 API配置
   - 检查单号格式
   - 查看服务器日志

## 📞 技术支持

### 日志位置

- 应用日志：`logs/app.log`
- 错误日志：`logs/error.log`

### 调试模式

在 `.env` 中设置：

```env
DEBUG=True
LOG_LEVEL=DEBUG
```

## 🔐 安全建议

1. **修改默认密码**
   - 登录后立即修改管理员密码

2. **保护敏感文件**
   - 不要提交 `.env` 文件到版本控制
   - 定期更新 `SECRET_KEY`

3. **数据库安全**
   - 使用强密码
   - 限制数据库访问权限
   - 定期备份数据

## 📊 性能优化

1. **数据库优化**
   - 添加索引
   - 定期清理日志
   - 使用连接池

2. **缓存策略**
   - 启用查询缓存
   - 使用Redis缓存

3. **文件处理**
   - 分批上传大文件
   - 使用异步处理

## 🎯 开发建议

1. **代码规范**
   - 遵循PEP 8
   - 添加类型注解
   - 编写文档字符串

2. **测试覆盖**
   - 单元测试
   - 集成测试
   - 性能测试

3. **版本控制**
   - 使用Git
   - 编写清晰的提交信息
   - 使用分支管理

## 📄 许可证

MIT License

## 👥 贡献

欢迎提交Issue和Pull Request！

---

**项目版本**: 1.0.0  
**最后更新**: 2024-01-28
